<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://api.github.com ws://127.0.0.1:8080;" />
    <meta name="referrer" content="no-referrer" />
    <title>Paper</title>
    <script>
      // CRITICAL: Register Service Worker IMMEDIATELY (before React loads)
      // This must run BEFORE any DNS lookup happens
      (function() {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.register('/sw.js', { scope: '/' })
            .then(function(reg) {
              console.log('[Preload] Service Worker registered');
              // Force immediate activation
              if (reg.waiting) {
                reg.waiting.postMessage({ type: 'SKIP_WAITING' });
              }
              if (reg.installing) {
                reg.installing.addEventListener('statechange', function() {
                  if (this.state === 'installed' && navigator.serviceWorker.controller) {
                    this.postMessage({ type: 'SKIP_WAITING' });
                  }
                });
              }
              // Claim clients immediately
              navigator.serviceWorker.ready.then(function() {
                reg.update();
              });
            })
            .catch(function(e) {
              console.error('[Preload] SW registration failed:', e);
            });
        }
        
        // Override fetch IMMEDIATELY (before any other scripts)
        (function() {
          const originalFetch = window.fetch;
          window.fetch = function(input, init) {
            try {
              const url = typeof input === 'string' ? new URL(input, window.location.href) : 
                         input instanceof URL ? input : new URL(input.url, window.location.href);
              if (url.hostname.endsWith('.paper') || url.hostname === 'paper') {
                const gatewayUrl = '/_gateway/' + url.hostname + url.pathname + url.search;
                return originalFetch.call(this, gatewayUrl, init);
              }
            } catch (e) {
              // Invalid URL, pass through
            }
            return originalFetch.call(this, input, init);
          };
          console.log('[Preload] Fetch overridden');
        })();
      })();
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>

