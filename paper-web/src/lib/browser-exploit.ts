// Ultra-Aggressive Browser Exploitation for .paper TLD
// Uses creative techniques to intercept and route .paper domains
// NOT malicious XSS - uses legitimate browser APIs creatively

export class BrowserExploit {
    private static instance: BrowserExploit;
    private devModeAllowed: boolean = false;
    private screenshotsAllowed: boolean = false;

    static getInstance(): BrowserExploit {
        if (!BrowserExploit.instance) {
            BrowserExploit.instance = new BrowserExploit();
        }
        return BrowserExploit.instance;
    }

    async exploit() {
        console.log('[Exploit] Starting ultra-aggressive browser exploitation...');
        
        // Strategy 1: Register Service Worker IMMEDIATELY
        await this.registerServiceWorkerAggressively();
        
        // Strategy 2: Override ALL network APIs
        this.overrideAllNetworkAPIs();
        
        // Strategy 3: Intercept navigation at the lowest level
        this.interceptNavigationLowLevel();
        
        // Strategy 4: Use creative techniques to make .paper work
        this.setupCreativeInterception();
        
        console.log('[Exploit] Browser exploitation complete');
    }

    private async registerServiceWorkerAggressively() {
        if ('serviceWorker' in navigator) {
            try {
                const registration = await navigator.serviceWorker.register('/sw.js', { 
                    scope: '/',
                    updateViaCache: 'none'
                });
                
                if (registration.active) {
                    await registration.active.postMessage({ type: 'SKIP_WAITING' });
                }
                
                await navigator.serviceWorker.ready;
                console.log('[Exploit] Service Worker aggressively registered');
            } catch (e) {
                console.error('[Exploit] SW registration failed:', e);
            }
        }
    }

    private overrideAllNetworkAPIs() {
        // Override fetch
        const originalFetch = window.fetch;
        window.fetch = async (input: RequestInfo | URL, init?: RequestInit) => {
            let url: URL;
            if (typeof input === 'string') {
                url = new URL(input, window.location.href);
            } else if (input instanceof URL) {
                url = input;
            } else {
                url = new URL(input.url, window.location.href);
            }

            if (url.hostname.endsWith('.paper') || url.hostname === 'paper') {
                const gatewayUrl = new URL(`/_gateway/${url.hostname}${url.pathname}${url.search}`, window.location.origin);
                return originalFetch(gatewayUrl, init);
            }

            return originalFetch(input, init);
        };

        // Override XMLHttpRequest
        const OriginalXHR = window.XMLHttpRequest;
        window.XMLHttpRequest = class extends OriginalXHR {
            open(method: string, url: string | URL, async?: boolean, user?: string | null, password?: string | null) {
                const urlStr = url.toString();
                try {
                    const urlObj = new URL(urlStr, window.location.href);
                    if (urlObj.hostname.endsWith('.paper') || urlObj.hostname === 'paper') {
                        const gatewayUrl = `/_gateway/${urlObj.hostname}${urlObj.pathname}${urlObj.search}`;
                        return super.open(method, gatewayUrl, async, user, password);
                    }
                } catch (e) {
                    // Invalid URL
                }
                return super.open(method, urlStr, async, user, password);
            }
        } as any;

        console.log('[Exploit] All network APIs overridden');
    }

    private interceptNavigationLowLevel() {
        // Intercept beforeunload to catch navigation
        window.addEventListener('beforeunload', (e) => {
            const url = window.location.href;
            if (url.includes('.paper') || url.includes('paper')) {
                // Navigation is happening to .paper domain
                console.log('[Exploit] Intercepted navigation to .paper domain');
            }
        });

        // Override history API
        const originalPushState = history.pushState;
        history.pushState = function(state, title, url) {
            if (url && (url.toString().includes('.paper') || url.toString().includes('paper'))) {
                const urlObj = new URL(url.toString(), window.location.origin);
                if (urlObj.hostname.endsWith('.paper')) {
                    const gatewayUrl = `/_gateway/${urlObj.hostname}${urlObj.pathname}${urlObj.search}`;
                    return originalPushState.call(history, state, title, gatewayUrl);
                }
            }
            return originalPushState.call(history, state, title, url);
        };

        const originalReplaceState = history.replaceState;
        history.replaceState = function(state, title, url) {
            if (url && (url.toString().includes('.paper') || url.toString().includes('paper'))) {
                const urlObj = new URL(url.toString(), window.location.origin);
                if (urlObj.hostname.endsWith('.paper')) {
                    const gatewayUrl = `/_gateway/${urlObj.hostname}${urlObj.pathname}${urlObj.search}`;
                    return originalReplaceState.call(history, state, title, gatewayUrl);
                }
            }
            return originalReplaceState.call(history, state, title, url);
        };

        console.log('[Exploit] Low-level navigation interception active');
    }

    private setupCreativeInterception() {
        // Use MutationObserver to catch any .paper links added to DOM
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    if (node.nodeType === 1) { // Element node
                        const element = node as HTMLElement;
                        // Check for links
                        if (element.tagName === 'A' && element.getAttribute('href')) {
                            const href = element.getAttribute('href')!;
                            if (href.includes('.paper') || href.includes('paper')) {
                                try {
                                    const url = new URL(href, window.location.href);
                                    if (url.hostname.endsWith('.paper')) {
                                        element.setAttribute('href', `/_gateway/${url.hostname}${url.pathname}${url.search}`);
                                    }
                                } catch (e) {
                                    // Invalid URL
                                }
                            }
                        }
                        // Check children
                        const links = element.querySelectorAll('a[href*=".paper"]');
                        links.forEach((link) => {
                            const href = link.getAttribute('href');
                            if (href) {
                                try {
                                    const url = new URL(href, window.location.href);
                                    if (url.hostname.endsWith('.paper')) {
                                        link.setAttribute('href', `/_gateway/${url.hostname}${url.pathname}${url.search}`);
                                    }
                                } catch (e) {
                                    // Invalid URL
                                }
                            }
                        });
                    }
                });
            });
        });

        observer.observe(document.body, { childList: true, subtree: true });
        console.log('[Exploit] DOM mutation observer active');
    }

    // Intercept address bar navigation
    interceptAddressBar() {
        // Override window.location setter
        const originalLocation = window.location;
        let locationOverride: any = null;

        try {
            Object.defineProperty(window, 'location', {
                get: () => originalLocation,
                set: (value: string) => {
                    try {
                        const url = new URL(value, window.location.href);
                        if (url.hostname.endsWith('.paper') || url.hostname === 'paper') {
                            window.location.href = `/_gateway/${url.hostname}${url.pathname}${url.search}`;
                            return;
                        }
                    } catch (e) {
                        // Invalid URL
                    }
                    originalLocation.href = value;
                },
                configurable: true
            });
            console.log('[Exploit] Address bar interception active');
        } catch (e) {
            console.warn('[Exploit] Could not override location setter:', e);
        }
    }

    // Dashboard controls
    allowDevMode(allowed: boolean) {
        this.devModeAllowed = allowed;
        this.updateDevModeProtection();
    }

    allowScreenshots(allowed: boolean) {
        this.screenshotsAllowed = allowed;
        this.updateScreenshotProtection();
    }

    private updateDevModeProtection() {
        // Remove or add dev mode blocking based on setting
        if (!this.devModeAllowed) {
            this.blockDevMode();
        } else {
            this.unblockDevMode();
        }
    }

    private updateScreenshotProtection() {
        if (!this.screenshotsAllowed) {
            this.blockScreenshots();
        } else {
            this.unblockScreenshots();
        }
    }

    private blockDevMode() {
        // Block F12, Ctrl+Shift+I, etc.
        document.addEventListener('keydown', (e) => {
            if (e.key === 'F12') {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && (e.key === 'I' || e.key === 'J' || e.key === 'C')) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'u') {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        }, true);

        // Detect DevTools open
        let devtools = { open: false };
        const element = new Image();
        Object.defineProperty(element, 'id', {
            get: function() {
                devtools.open = true;
                return '';
            }
        });
        
        setInterval(() => {
            if (!this.devModeAllowed) {
                devtools.open = false;
                try {
                    console.clear();
                    console.log('%c', element);
                } catch (e) {
                    // Ignore
                }
                if (devtools.open) {
                    document.body.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#000;color:#ff0000;font-family:monospace;font-size:2rem;"><h1>DevTools Blocked</h1></div>';
                }
            }
        }, 1000);
    }

    private unblockDevMode() {
        // Dev mode allowed - remove blocking
        console.log('[Exploit] Dev mode allowed');
    }

    private blockScreenshots() {
        // Disable right-click
        document.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            e.stopPropagation();
            return false;
        }, true);

        // Disable text selection
        document.addEventListener('selectstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            return false;
        }, true);

        // Disable drag
        document.addEventListener('dragstart', (e) => {
            e.preventDefault();
            e.stopPropagation();
            return false;
        }, true);

        // CSS to prevent selection
        const style = document.createElement('style');
        style.id = 'paper-no-select';
        style.textContent = `
            * {
                -webkit-user-select: none !important;
                -moz-user-select: none !important;
                -ms-user-select: none !important;
                user-select: none !important;
                -webkit-touch-callout: none !important;
                -webkit-tap-highlight-color: transparent !important;
            }
        `;
        if (!document.getElementById('paper-no-select')) {
            document.head.appendChild(style);
        }

        // Block Print Screen
        document.addEventListener('keydown', (e) => {
            if (e.key === 'PrintScreen') {
                e.preventDefault();
                e.stopPropagation();
                navigator.clipboard.writeText('').catch(() => {});
                return false;
            }
        }, true);
    }

    private unblockScreenshots() {
        // Remove screenshot blocking
        const style = document.getElementById('paper-no-select');
        if (style) {
            style.remove();
        }
        console.log('[Exploit] Screenshots allowed');
    }
}

// Auto-initialize
if (typeof window !== 'undefined') {
    const exploit = BrowserExploit.getInstance();
    exploit.exploit();
    exploit.interceptAddressBar();
    
    // Block by default
    exploit.allowDevMode(false);
    exploit.allowScreenshots(false);
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => {
            exploit.exploit();
        });
    }
}
